<!DOCTYPE html>
<!--[if IE 7]>
<html class="ie ie7" lang="en-US">
<![endif]-->
<!--[if IE 8]>
<html class="ie ie8" lang="en-US">
<![endif]-->
<!--[if !(IE 7) | !(IE 8)  ]><!-->
<html lang="en-US">
<!--<![endif]-->
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<title>mind the explanatory gap | many a slip &#039;twixt mind and lip&#8230; | Page 6</title>
	<link rel="profile" href="http://gmpg.org/xfn/11">
		<!--[if lt IE 9]>
	<script src="http://explanatorygap.net/wp-content/themes/twentythirteen/js/html5.js"></script>
	<![endif]-->
	<link rel="alternate" type="application/rss+xml" title="mind the explanatory gap &raquo; Feed" href="http://explanatorygap.net/wp-content/plugins/really-static/static/feed/" />

<link rel='stylesheet' id='wpcf-css'  href='http://explanatorygap.net/wp-content/plugins/wp-contact-form/wpcf.css?ver=20110218' type='text/css' media='all' />
<link rel='stylesheet' id='twentythirteen-fonts-css'  href='//fonts.googleapis.com/css?family=Source+Sans+Pro%3A300%2C400%2C700%2C300italic%2C400italic%2C700italic%7CBitter%3A400%2C700&#038;subset=latin%2Clatin-ext' type='text/css' media='all' />
<link rel='stylesheet' id='genericons-css'  href='http://explanatorygap.net/wp-content/themes/twentythirteen/fonts/genericons.css?ver=2.09' type='text/css' media='all' />
<link rel='stylesheet' id='twentythirteen-style-css'  href='http://explanatorygap.net/wp-content/themes/twentythirteen/style.css?ver=2013-07-18' type='text/css' media='all' />
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentythirteen-ie-css'  href='http://explanatorygap.net/wp-content/themes/twentythirteen/css/ie.css?ver=2013-07-18' type='text/css' media='all' />
<![endif]-->
<script type='text/javascript' src='http://explanatorygap.net/wp-includes/js/jquery/jquery.js?ver=1.11.0'></script>
<script type='text/javascript' src='http://explanatorygap.net/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.2.1'></script>
<script type='text/javascript' src='http://explanatorygap.net/wp-content/plugins/google-analyticator/external-tracking.min.js?ver=6.4.7.3'></script>
<meta name="generator" content="WordPress 3.9.1 - really-static 0.5" />
<link rel="stylesheet" href="http://explanatorygap.net/wp-content/plugins/source-code-syntax-highlighting-plugin-for-wordpress/geshi.css"  type="text/css" />	<style type="text/css" id="twentythirteen-header-css">
			.site-header {
			background: url(http://explanatorygap.net/wp-content/themes/twentythirteen/images/headers/star.png) no-repeat scroll top;
			background-size: 1600px auto;
		}
		</style>
	<!-- Google Analytics Tracking by Google Analyticator 6.4.7.3: http://www.videousermanuals.com/google-analyticator/ -->
<script type="text/javascript">
                var analyticsFileTypes = [''];
                            var analyticsSnippet = 'enabled';
                var analyticsEventTracking = 'enabled';
            </script>
<script type="text/javascript">
	var _gaq = _gaq || [];
  
	_gaq.push(['_setAccount', 'UA-719433-1']);
    _gaq.push(['_addDevId', 'i9k95']); // Google Analyticator App ID with Google
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</head>

<body class="home blog paged paged-6 single-author">
	<div id="page" class="hfeed site">
		<header id="masthead" class="site-header" role="banner">
			<a class="home-link" href="http://explanatorygap.net/wp-content/plugins/really-static/static/" title="mind the explanatory gap" rel="home">
				<h1 class="site-title">mind the explanatory gap</h1>
				<h2 class="site-description">many a slip &#039;twixt mind and lip&#8230;</h2>
			</a>

			<div id="navbar" class="navbar">
				<nav id="site-navigation" class="navigation main-navigation" role="navigation">
					<h3 class="menu-toggle">Menu</h3>
					<a class="screen-reader-text skip-link" href="#content" title="Skip to content">Skip to content</a>
					<div class="nav-menu"><ul><li class="page_item page-item-2"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/about/">About/Contact</a></li><li class="page_item page-item-278"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/os-x-puppet-pkgs/">OS X Puppet pkgs</a></li></ul></div>
					<form role="search" method="get" class="search-form" action="http://explanatorygap.net/wp-content/plugins/really-static/static/">
				<label>
					<span class="screen-reader-text">Search for:</span>
					<input type="search" class="search-field" placeholder="Search &hellip;" value="" name="s" title="Search for:" />
				</label>
				<input type="submit" class="search-submit" value="Search" />
			</form>				</nav><!-- #site-navigation -->
			</div><!-- #navbar -->
		</header><!-- #masthead -->

		<div id="main" class="site-main">

	<div id="primary" class="content-area">
		<div id="content" class="site-content" role="main">
		
										
<article id="post-89" class="post-89 post type-post status-publish format-standard hentry category-ramblings">
	<header class="entry-header">
		
				<h1 class="entry-title">
			<a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/08/04/off-to-wwdc-2006/" rel="bookmark">Off to WWDC 2006&#8230;</a>
		</h1>
		
		<div class="entry-meta">
			<span class="date"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/08/04/off-to-wwdc-2006/" title="Permalink to Off to WWDC 2006&#8230;" rel="bookmark"><time class="entry-date" datetime="2006-08-04T17:49:39+00:00">August 4, 2006</time></a></span><span class="categories-links"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/ramblings/" title="View all posts in ramblings" rel="category tag">ramblings</a></span><span class="author vcard"><a class="url fn n" href="http://explanatorygap.net/wp-content/plugins/really-static/static/author/nigelkersten/" title="View all posts by nigel kersten" rel="author">nigel kersten</a></span>					</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

		<div class="entry-content">
		<p>Drinking my coffee, mentally double-checking that I&#8217;ve packed everything&#8230;<br />
<br />
<i>Oh no, 13 and a half hours on the plane means that long <b>without decent coffee</b>. ugh</i><br />
<br />
So it&#8217;s that time of year again&#8230; I&#8217;d love to chat to anyone in person who actually reads this blog, I&#8217;m still not entirely convinced that awstats isn&#8217;t just making up all these web statistics&#8230; :)</p>
<p>I&#8217;ll be at the MacEnterprise event on Sunday night (and probably the Australia/New Zealand meetup as well), and will be at the <a href="http://www.afp548.com">afp548.com</a> event on Tuesday night.  I&#8217;ll be putting on my best tough Australian guy act as the door guy from 9:45 to 10:20, so please come up and say hi!</p>
			</div><!-- .entry-content -->
	
	<footer class="entry-meta">
					<div class="comments-link">
				<a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/08/04/off-to-wwdc-2006/#respond" title="Comment on Off to WWDC 2006&#8230;"><span class="leave-reply">Leave a comment</span></a>			</div><!-- .comments-link -->
		
			</footer><!-- .entry-meta -->
</article><!-- #post -->
							
<article id="post-90" class="post-90 post type-post status-publish format-standard hentry category-macosx">
	<header class="entry-header">
		
				<h1 class="entry-title">
			<a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/07/14/plistbuddy-is-the-shiznit/" rel="bookmark">PlistBuddy is the shiznit..</a>
		</h1>
		
		<div class="entry-meta">
			<span class="date"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/07/14/plistbuddy-is-the-shiznit/" title="Permalink to PlistBuddy is the shiznit.." rel="bookmark"><time class="entry-date" datetime="2006-07-14T00:24:17+00:00">July 14, 2006</time></a></span><span class="categories-links"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/macosx/" title="View all posts in macosx" rel="category tag">macosx</a></span><span class="author vcard"><a class="url fn n" href="http://explanatorygap.net/wp-content/plugins/really-static/static/author/nigelkersten/" title="View all posts by nigel kersten" rel="author">nigel kersten</a></span>					</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

		<div class="entry-content">
		<p>So I&#8217;ve been meaning to start using PlistBuddy for a while, and this morning I ran into a real need for it.</p>
<p>Unbeknownst to me, we had a problem with our imaging system where a machine would be freshly imaged, and it would retain the LocalHostName and ComputerName of the imaged machine until the next reboot.</p>
<p>(We normally set these values to &#8220;hostname -s&#8221; as part of a StartupItem)</p>
<p>Anyway, I wanted to set these values when machines are booted from our custom NetInstall image, and quite frankly, using &#8220;defaults&#8221; with nested dictionaries can sometimes either be an absolute pain in the ass, or impossible. </p>
<p>Obviously someone at Apple realised this a while ago, which is why they invented PlistBuddy. If you do &#8220;locate PlistBuddy&#8221; from a shell, you&#8217;re likely to see it in all sorts of Apple packages, and I feel perfectly comfortable simply stealing one of them&#8230;</p>
<p>PlistBuddy lets you easily write nested values and merge dictionaries into each other.</p>
<p>Here&#8217;s the two liner that lets you set the relevant values (as root/sudo etc)<br />
</p>
<pre>
$ PlistBuddy -c "Set :System:Network:HostNames:LocalHostName $(hostname -s)"  \
/Library/Preferences/SystemConfiguration/preferences.plist 
$ /PlistBuddy -c "Set :System:System:ComputerName $(hostname -s)" \
/Library/Preferences/SystemConfiguration/preferences.plist 
</pre>
<p>And for us we just point it to /Volumes/System/Library/&#8230; etc as that&#8217;s where the SOE partition is while NetBooting.</p>
<p>Much nicer than using defaults&#8230;</p>
			</div><!-- .entry-content -->
	
	<footer class="entry-meta">
					<div class="comments-link">
				<a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/07/14/plistbuddy-is-the-shiznit/#comments" title="Comment on PlistBuddy is the shiznit..">View all 7 comments</a>			</div><!-- .comments-link -->
		
			</footer><!-- .entry-meta -->
</article><!-- #post -->
							
<article id="post-91" class="post-91 post type-post status-publish format-standard hentry category-macosx">
	<header class="entry-header">
		
				<h1 class="entry-title">
			<a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/06/08/moving-the-hibernate-image-file-on-a-macbookpro/" rel="bookmark">Moving the hibernate image file on a MacBookPro&#8230;</a>
		</h1>
		
		<div class="entry-meta">
			<span class="date"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/06/08/moving-the-hibernate-image-file-on-a-macbookpro/" title="Permalink to Moving the hibernate image file on a MacBookPro&#8230;" rel="bookmark"><time class="entry-date" datetime="2006-06-08T20:26:23+00:00">June 8, 2006</time></a></span><span class="categories-links"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/macosx/" title="View all posts in macosx" rel="category tag">macosx</a></span><span class="author vcard"><a class="url fn n" href="http://explanatorygap.net/wp-content/plugins/really-static/static/author/nigelkersten/" title="View all posts by nigel kersten" rel="author">nigel kersten</a></span>					</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

		<div class="entry-content">
		<p>So I like to partition my Macs so that my user directory is on a different partition to the system drive.<br />
I got kind of frustrated when I got my MacBook Pro and realised that due to having 2Gb of RAM, the hibernate settings by default were taking up an extra 2Gb on my system partition with the sleep image file at /var/vm/sleepimage.</p>
<p>After poking around with pmset for a while, I realised that you can move the image file&#8230;</p>
<pre>
sudo pmset -a hibernatefile /Volumes/OtherVolume/sleepimage
</pre>
<p>Then trash /var/vm/sleepimage, and all seems hunky-dory&#8230;</p>
<p>There are some other useful settings I&#8217;ve seen people mention on the web, like setting:</p>
<pre>
sudo pmset -a  hibernatemode x
</pre>
<p>Where x is an integer meaning:<br />
</p>
<ul>
<li>0 &#8211; disable hibernate mode.</li>
<li>1 &#8211; hibernate when shutting the lid instead of sleeping.</li>
<li>3 &#8211; normal hibernate settings.</li>
<li>5 &#8211; hibernate when shutting the lid instead of sleeping (with secure virtual memory turned on)</li>
<li>7 &#8211; normal hibernate settings (with secure virtual memory turned on)</li>
</ul>
<p>
I wonder what the even numbers do&#8230;</p>
			</div><!-- .entry-content -->
	
	<footer class="entry-meta">
					<div class="comments-link">
				<a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/06/08/moving-the-hibernate-image-file-on-a-macbookpro/#comments" title="Comment on Moving the hibernate image file on a MacBookPro&#8230;">View all 5 comments</a>			</div><!-- .comments-link -->
		
			</footer><!-- .entry-meta -->
</article><!-- #post -->
							
<article id="post-92" class="post-92 post type-post status-publish format-standard hentry category-software-and-scripts">
	<header class="entry-header">
		
				<h1 class="entry-title">
			<a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/05/13/siradmin-a-gui-replacement-for-cyradm/" rel="bookmark">SirAdmin &#8230; a GUI replacement for cyradm</a>
		</h1>
		
		<div class="entry-meta">
			<span class="date"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/05/13/siradmin-a-gui-replacement-for-cyradm/" title="Permalink to SirAdmin &#8230; a GUI replacement for cyradm" rel="bookmark"><time class="entry-date" datetime="2006-05-13T01:44:34+00:00">May 13, 2006</time></a></span><span class="categories-links"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/software-and-scripts/" title="View all posts in software and scripts" rel="category tag">software and scripts</a></span><span class="author vcard"><a class="url fn n" href="http://explanatorygap.net/wp-content/plugins/really-static/static/author/nigelkersten/" title="View all posts by nigel kersten" rel="author">nigel kersten</a></span>					</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

		<div class="entry-content">
		<p>Moved to:</p>
<p><a href="https://sites.google.com/a/explanatorygap.net/siradmin/">https://sites.google.com/a/explanatorygap.net/siradmin/</a></p>
<p> </p>
<p><strong>Edit:</strong> Version <span style="font-weight: bold">0.86b2</span> now available. (<span style="font-style: italic">22/03/2007</span>)</p>
<p>I initially wrote SirAdmin as a diagnostic tool, so that when users reported problems with certain mailboxes, my IT support staff who were not comfortable with the command line interface of <em>cyradm</em> could assign themselves an ACL to view such mailboxes in their own email client in order to quickly diagnose whether the reported problem was server-side or client-side.</p>
<p>However, it quickly became apparent that the usefuleness of this app extended beyond that, in that it allows non-admin users to share mailboxes with one another.</p>
<p>If you&#8217;re not familiar with cyradm, it is a command line tool that ships with the Cyrus IMAP server. You can see the man page for it <a href="http://developer.apple.com/documentation/Darwin/Reference/ManPages/man1/cyradm.1.html">here at developer.apple.com</a>, and O&#8217;Reilly have <a href="http://www.oreilly.com/catalog/mimap/chapter/ch09.html">published Chapter 9: Cyrus System Administration</a> for free from their book <em>Managing IMAP</em>.</p>
<p>So my app SirAdmin is essentially a GUI replacement for cyradm, in that it allows you to locally <em>or remotely</em> administer your Cyrus IMAP server.  I&#8217;ve tested it against the Cyrus server from Mac OS X Server 10.3 and 10.4, as well as Cyrus running on RedHat. It isn&#8217;t merely a wrapper around the cyradm code by the way. All the bugs are my own&#8230; :)</p>
<p><strong>It does require OS X 10.4 on the <em>client</em>, where you are running the application</strong>, although you can talk to 10.3 IMAP servers</p>
<p>It allows you to create, rename, delete and reconstruct mailboxes, and also allows you to set Access Control Lists for IMAP mailboxes. This is perhaps the most useful function, in that as an admin you can create globally shared mailboxes, or as a user you can choose to share out parts of your IMAP mailbox hierarchy with other users. It also gives you an easy interface to be able to configure &#8220;plus addressing&#8221;, where you can send emails to <em>postuser+aSharedMailbox@your.mail.doman</em> and have them be delivered directly to a particular mailbox, rather than to the inbox of a particular user.</p>
<p>Here are some screenshots to illustrate what you can do:<br />
<img src="/siradmin/SirAdmin.png" alt="" /></p>
<p><img src="/siradmin/createACLScreenshot.png" alt="" /><br />
<img src="/siradmin/EditMetadata.png" alt="" /></p>
<p><img src="/siradmin/globalSharedFolder.png" alt="" /></p>
<p>It&#8217;s still a  work in development, the obviously missing features are:</p>
<ul>
<li>Kerberos support</li>
<li>The ability to specify particular mail partitions for particular mailboxes</li>
<li>Untested behind a SOCKS proxy (would love feedback on this&#8230;)</li>
<li>Mac Help for SirAdmin isn&#8217;t finished</li>
<li>I&#8217;m also working on more diagnostic info, like number of messages in a mailbox, last message received, view message excerpts, etc.</li>
</ul>
<p>but it currently does some nifty stuff like:</p>
<ul>
<li>Keychain Support.</li>
<li>SSL support.</li>
<li>CRAM-MD5 support, with an attempted fallback to plain-text</li>
<li>Create, Delete, Rename, Reconstruct Mailboxes.</li>
<li>Create, Delete Access Control Lists for Maiboxes.</li>
<li>Auto-complete usernames for ACLs based upon global mailbox listing</li>
<li>Auto-complete usernames by searching your configured Directory Access nodes, with optional min/max uid filtering</li>
<li>View Quotas, Quota Root and Quota Used.</li>
<li>View and Edit Mailbox Comments, Squat Indexing, and Auto-Expiry age for messages</li>
<li>View Mailbox Last Updated date, size and partition</li>
</ul>
<p>Anyway, if you&#8217;re interested in grabbing a copy, <a href="/sw/SirAdmin.app.zip">you can get version 0.86b2 here.</a><br />
I&#8217;d love feedback on it, particular bug reports or suggestions for further utility. You can either email me or leave comments here.</p>
<p><strong>Edit:</strong> I&#8217;m particularly keen on suggestions for the docs. Some comments below have illustrated that I need to explain Cyrus ACLs better. Thanks for that.</p>
<p>Thanks go out to:</p>
<ul>
<li>Mark Daniel for designing the icon</li>
<li>Dustin Voss for his most excellent <a href="http://www.cocoadev.com/index.pl?AsyncSocket">AsyncSocket class</a></li>
<li><a href="http://homepage.mac.com/agerson/">Adam Gerson</a> for his useful <a href="http://homepage.mac.com/agerson/examples/keychain/">AGKeychain class</a></li>
<li><a href="http://www.dribin.org/dave/">Dave Dribin</a> for his <a href="http://www.cocoadev.com/index.pl?BaseSixtyFour">Base64 encoding/decoding categories</a></li>
</ul>
			</div><!-- .entry-content -->
	
	<footer class="entry-meta">
		
			</footer><!-- .entry-meta -->
</article><!-- #post -->
							
<article id="post-93" class="post-93 post type-post status-publish format-standard hentry category-macosx">
	<header class="entry-header">
		
				<h1 class="entry-title">
			<a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/04/03/how-os-x-launches-applications/" rel="bookmark">How OS X launches Applications&#8230;</a>
		</h1>
		
		<div class="entry-meta">
			<span class="date"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/04/03/how-os-x-launches-applications/" title="Permalink to How OS X launches Applications&#8230;" rel="bookmark"><time class="entry-date" datetime="2006-04-03T18:42:32+00:00">April 3, 2006</time></a></span><span class="categories-links"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/macosx/" title="View all posts in macosx" rel="category tag">macosx</a></span><span class="author vcard"><a class="url fn n" href="http://explanatorygap.net/wp-content/plugins/really-static/static/author/nigelkersten/" title="View all posts by nigel kersten" rel="author">nigel kersten</a></span>					</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

		<div class="entry-content">
		<p><b>Quickie:</b> A very nice article on <a href="http://0xfe.blogspot.com/2006/03/how-os-x-executes-applications.html">how OS X launches applications</a> and a follow-up <a href="http://0xfe.blogspot.com/2006/03/qa-how-os-x-executes-applications.html">Q &#038; A</a>.</p>
			</div><!-- .entry-content -->
	
	<footer class="entry-meta">
					<div class="comments-link">
				<a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/04/03/how-os-x-launches-applications/#respond" title="Comment on How OS X launches Applications&#8230;"><span class="leave-reply">Leave a comment</span></a>			</div><!-- .comments-link -->
		
			</footer><!-- .entry-meta -->
</article><!-- #post -->
							
<article id="post-94" class="post-94 post type-post status-publish format-standard hentry category-macosx category-macosxserver">
	<header class="entry-header">
		
				<h1 class="entry-title">
			<a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/03/30/greg-neagles-managing-os-x-blog/" rel="bookmark">Greg Neagle&#39;s Managing OS X blog&#8230;</a>
		</h1>
		
		<div class="entry-meta">
			<span class="date"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/03/30/greg-neagles-managing-os-x-blog/" title="Permalink to Greg Neagle&#039;s Managing OS X blog&#8230;" rel="bookmark"><time class="entry-date" datetime="2006-03-30T20:30:51+00:00">March 30, 2006</time></a></span><span class="categories-links"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/macosx/" title="View all posts in macosx" rel="category tag">macosx</a>, <a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/macosxserver/" title="View all posts in macosxserver" rel="category tag">macosxserver</a></span><span class="author vcard"><a class="url fn n" href="http://explanatorygap.net/wp-content/plugins/really-static/static/author/nigelkersten/" title="View all posts by nigel kersten" rel="author">nigel kersten</a></span>					</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

		<div class="entry-content">
		<p>I&#8217;ve just added a link to it in the side column, but it&#8217;s well worthwhile checking out Greg Neagle&#8217;s <a href="http://managingosx.wordpress.com/">Managing OS X</a> blog.</p>
<p>There are <a>getting the screensaver to work over the loginwindow</a>, <a href="http://managingosx.wordpress.com/2006/03/15/portable-home-directories-without-open-directory/">several</a>, <a href="http://managingosx.wordpress.com/2006/03/16/portable-home-directories-without-open-directory-part-2/">really</a>, <a href="http://managingosx.wordpress.com/2006/03/16/portable-home-directories-without-open-directory-part-2-2/">good</a> <a href="http://managingosx.wordpress.com/2006/03/22/more-on-portable-home-directories/">posts</a> on using Portable Home Directories without Open Directory.</p>
			</div><!-- .entry-content -->
	
	<footer class="entry-meta">
					<div class="comments-link">
				<a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/03/30/greg-neagles-managing-os-x-blog/#respond" title="Comment on Greg Neagle&#039;s Managing OS X blog&#8230;"><span class="leave-reply">Leave a comment</span></a>			</div><!-- .comments-link -->
		
			</footer><!-- .entry-meta -->
</article><!-- #post -->
							
<article id="post-95" class="post-95 post type-post status-publish format-standard hentry category-macosxserver">
	<header class="entry-header">
		
				<h1 class="entry-title">
			<a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/03/29/afp-it-aint-so-bad/" rel="bookmark">AFP. It ain&#39;t so bad.</a>
		</h1>
		
		<div class="entry-meta">
			<span class="date"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/03/29/afp-it-aint-so-bad/" title="Permalink to AFP. It ain&#039;t so bad." rel="bookmark"><time class="entry-date" datetime="2006-03-29T22:17:50+00:00">March 29, 2006</time></a></span><span class="categories-links"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/macosxserver/" title="View all posts in macosxserver" rel="category tag">macosxserver</a></span><span class="author vcard"><a class="url fn n" href="http://explanatorygap.net/wp-content/plugins/really-static/static/author/nigelkersten/" title="View all posts by nigel kersten" rel="author">nigel kersten</a></span>					</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

		<div class="entry-content">
		<h2>AFP. It ain&#8217;t so bad.</h2>
<p>From looking at the mailing lists and discussion boards, you&#8217;ll see that a reasonable number of people seem to be having problems with their AFP servers under OS X Server 10.4.x, particularly under heavy load with network home directories, and particularly in terms of stability. I used to be one of those people, but the solutions presented in this article have (touch wood) resolved the vast majority of my issues.</p>
<p>Whereas under 10.3 I used to get a symptom where the whole server would lock up and not even be pingable, the symptoms I&#8217;ve seen under 10.4.x have been entirely related to the AFP server. Login times will get longer and longer, access speed becomes slower and slower, and eventually the AFP server enters a death spiral, where the only recourse seems to be restarting the service. </p>
<p>I&#8217;m going to quickly cover some of the more commonly known fixes and workarounds that I&#8217;d tried before these major solutions.</p>
<p><b>1) Make sure DNS is working</b> with proper forward and reverse entries for your servers at the bare minimum, and preferably all your client machines as well.</p>
<p><b>2) Redirect ~/Library/Caches to a local folder for network home directory users.</b><br />
  This makes quite a big difference. If you start watching your AFP server logs, you&#8217;ll notice that your network home directory users hit the cache a lot, particularly for apps like Safari. We do this with a login hook that redirects ~/Library/Caches to /Library/Caches/username/.  </p>
<p><b>3) Disable creation of .DS_Store files for network mounts. </b><br />
  There  is an <a href="http://docs.info.apple.com/article.html?artnum=301711">Apple techinfo article</a> up about this. From debugging, it looks like a corrupt .DS_Store file can create all sorts of problems, particularly if you have a setup like mine, where students have read-only access to certain network folders, and lecturers have write-access.  I&#8217;ve used MCX to push out the above setting, and then run a command like this to delete all existing .DS_Store files on the sharepoint.  The problem with this solution is that your users will get a bit narky about no longer being able to have window settings &#8216;stick&#8217; across sessions.</p>
<p><b>4) Check the integrity of your filesystem.</b></p>
<p><b>5) Put more RAM in your server.</b><br />
  I was previously looking at swapfile creation and vm_stat to work out whether my AFP servers needed more RAM, however the problem seems to be that the AFP server tries to avoid swapping to disk, and so these aren&#8217;t good metrics to work from. As soon as I stuck a couple more gig into my servers, they started using it&#8230;</p>
<p><b>6) Move heavy users to Mobile Accounts with Portable Home Directories. </b><br />
  This isn&#8217;t applicable in all situations, and there&#8217;s no way I could move all my students to Mobile Accounts, but for my staff members who use Office and Mail heavily, performance on a network home directory isn&#8217;t that great, even on a fast connection. If you have users who primarily use a single machine, Mobile Accounts where you control the synchronisation settings via MCX give you the best of both worlds.</p>
<p><b>7) Increase the sysctl parameters for max files and max files per process.</b><br />
  This is a more general tuning tip for OS X Server, but as Rob Middleton pointed out to me, without it, if you have AFP error logging on, it helpfully logs several hundred lines per second to inform you that it can&#8217;t open files&#8230; filling up your primary partition rather quickly&#8230;<br />
  Create /etc/sysctl.conf with the following parameters:<br />
  <code><br />
  kern.maxfiles=200000<br />
 <br />
  kern.maxfilesperproc=50000<br />
  </code><br />
<br />
  If you want to apply those settings immediately, rather than waiting for a reboot you can do: <br />
  <code><br />
    for i in $(cat /etc/sysctl.conf); do sysctl -w $i; done<br />
  </code>
  </p>
<p></p>
<p>Now onto the more interesting fixes&#8230;</p>
<p><b>1) Tweaking the WAN threshold and packet size <i>on the clients</i></b></p>
<p>If you run this command on a client machine, you can see various AFP client tuning parameters. Some of your settings may be slightly different to these.</p>
<pre>
  nigelkersten@zombie: ~ $ defaults read -g com.apple.AppleShareClientCore
  {
      "afp_active_timeout" = 0; 
      "afp_authtype_show" = 0; 
      "afp_cleartext_allow" = 1; 
      "afp_cleartext_warn" = 1; 
      "afp_debug_level" = 6; 
      "afp_debug_syslog" = 0; 
      "afp_default_name" = ""; 
      "afp_idle_timeout" = 0; 
      "afp_keychain_add" = 1; 
      "afp_keychain_search" = 1; 
      "afp_login_displayGreeting" = 1; 
      "afp_maxDirCache" = 60; 
      "afp_maxFileCache" = 60; 
      "afp_minDirCache" = 5; 
      "afp_minFileCache" = 5; 
      "afp_mount_defaultFlags" = 0; 
      "afp_no_kQueues" = 0; 
      "afp_no_volChange_caching" = 1; 
      "afp_prefs_version" = 2; 
      "afp_reconnect_allow" = 1; 
      "afp_reconnect_interval" = 10; 
      "afp_reconnect_retries" = 12; 
      "afp_ssh_allow" = 0; 
      "afp_ssh_force" = 0; 
      "afp_ssh_require" = 0; 
      "afp_ssh_warn" = 1; 
      "afp_use_default_name" = 0; 
      "afp_use_short_name" = 0; 
      "afp_voldlog_skipIfOnly" = 0; 
      "afp_wan_quantum" = 8192; 
      "afp_wan_threshold" = 30; 
  }
  </pre>
<p>Of particular interest are these two settings, &#8216;afp_wan_quantum&#8217; and &#8216;afp_wan_threshold&#8217;.  The values I&#8217;ve shown here should be the defaults, but you may have a setting of 0 for both of them.  These are used by the client to work out whether a particular AFP connection is over a LAN or WAN connection.  If the latency of a given connection is higher than the value in afp_wan_threshold, then the data chunk size drops from 128KiB (the default for a LAN connection) to 8KiB, the setting shown here.</p>
<p>The problem seems to be that this default threshold setting is way too low, and once the AFP server starts experiencing moderate load, your LAN clients start using the WAN data chunk size. Although smaller chunks are desirable for slow connections, they induce an overhead on the server in terms of processing as the server is dealing with 16x the number of chunks, and reduce overall throughput. A symptom of this is high CPU usage.</p>
<p>The good news is that we can change these settings. The values you choose are up to you, and depend largely upon whether you actually do have WAN clients to support, so I&#8217;m going to suggest two scenarios:</p>
<p><b>First scenario: No WAN clients </b>(cause AFP sucks over slow connections anyway :) )</p>
<pre>
    afp_wan_quantum = 131072
    afp_wan_threshold = 1000
    </pre>
<p>This is a bit of a shotgun approach. Bring the latency threshold way up, and even if the clients reach this threshold, force their chunk size to be the same as that of a LAN client.  This is what I&#8217;ve done in my environment, mainly because I wanted to make sure that I could rule out this issue. As time goes on, and once I work out the correct way to measure latency for a client (see the footnote at the end), I&#8217;ll come up with more sane values, but at this stage, I just needed to stop my lecturers from revolting en masse due to AFP stability issues.</p>
<p><b>Second scenario: Some WAN clients who use AFP </b>(I feel their pain&#8230;)</p>
<pre>
  afp_wan_quantum = 8192
  afp_wan_threshold = 200
  </pre>
<p>This is <i>very much a guesstimate on my part</i>. I&#8217;ve done a few tests at a threshold of 100, and I&#8217;ve found that LAN clients were still getting the WAN chunk size when I set the threshold at 100. Again, see the footnote at the end, as I&#8217;d like to find out a way of getting an accurate picture of the latency a client is experiencing.</p>
<p>So as far as this setting goes, the good news (for me) is that it has almost entirely resolved performance issues with the AFP server under moderate load.  I&#8217;ve also been experimenting with the maxFileCache and maxDirCache settings, and even when I&#8217;ve been increasing them from 60 to 6000, I&#8217;ve been unable to replicate any stale cache issues. If you so desire, try playing around with those settings.</p>
<p><b>Applying these settings to a client machine.</b></p>
<p>Well, there are a couple of options you have here.</p>
<p><i>1) Apply the settings manually.</i></p>
<p> One way would be to use a LoginHook to set these parameters using the defaults command. ie, the first scenario above could be done with the following two commands:</p>
<pre>
    defaults write -g com.apple.AppleShareClientCore -dict-add afp_wan_quantum -int 131702
    defaults write -g com.apple.AppleShareClientCore -dict-add afp_wan_threshold -int 1000
  </pre>
<p>The &#8220;-g&#8221; refers to the fact that we&#8217;re writing these settings into the Global Domain, (for a user, at ~/Library/Preferences/.GlobalPreferences.plist), -dict-add means you&#8217;re adding a key value to a dictionary (named &#8220;com.apple.AppleShareClientCore&#8221;), and -int means you&#8217;re adding an integer value.</p>
<p>This may be the best solution for your environment, and is a good place to start testing before you move onto the next method&#8230;</p>
<p><i>2) Use MCX to manage the settings.</i></p>
<p>This is the way I&#8217;ve done it, as it has some nice side effects, and is more The Apple Way &#153. As with all such settings, you can choose to do this at the user or group level. I&#8217;ve chosen to do it to my two main groups that cover all my staff and all my students.</p>
<ul>
<li> Open up Workgroup Manager, and choose the group or user you wish to apply these settings to. Click on the toolbar item &#8216;Preferences&#8217; and then the tab &#8216;Details&#8217; to the right.</li>
<li> Click on the &#8216;Add&#8217; button, and navigate to your own home folder. Choose &#8220;.GlobalPreferences.plist&#8221;. You&#8217;ll now see it appear in the Preferences pane. </li>
<li> Double click on the .GlobalPreferences item to edit it. You&#8217;ll notice that the settings have been put into &#8216;Often&#8217; rather than &#8216;Always&#8217; or &#8216;Once&#8217;.  I&#8217;ve had some really odd behaviour with trying to get the global defaults domain to be managed &#8216;Always&#8217;, and &#8216;Often&#8217; has been working happily for me, so let&#8217;s leave it set that way.</li>
<li> If you have any other items other than the &#8216;com.apple.AppleShareClientCore&#8217; dictionary, delete them, unless of course you wish to manage those settings for your users as well. Click on the triangle next to the AppleShareClientCore dictionary to expand it.</li>
<li> Here you can see the relevant settings. Change the afp_wan_threshold and afp_wan_quantum values to the ones you&#8217;ve decided to use. Click on &#8216;Apply Now&#8217;.</li>
</ul>
<p>Done! A really nice side effect of doing things this way is that you can now centrally manage a bunch of other afp connection settings, and perhaps most usefully, you can turn on AFP client side debugging using MCX for all your users. The AFP server itself isn&#8217;t particularly useful at giving debugging info, but the client is actually quite good. The footnote at the bottom will explain how to turn on client-side debugging.</p>
<p>Since I applied these changes, I&#8217;ve seen a drastic change in stability and performance under load. However&#8230; resolving this issue has pointed to another problem with Apple&#8217;s default settings, and I&#8217;ve noticed that the server is still slowing down under much heavier load, and still not using all the resources available to it.</p>
<p>There are a few oddities here though. It seems like global preferences shouldn&#8217;t take effect until the home directory is actually mounted, but perhaps by putting the prefs into MCX, we&#8217;re having them take effect before the actual home directory has mounted&#8230; ?</p>
<p>If anyone goes down the manual path setting, I&#8217;d like to hear if you&#8217;re finding these settings aren&#8217;t taking effect</p>
<p><b>2) Tweaking the maximum # of threads on <i>on the server</i></b></p>
<p>The AFP server saw a change in 10.4, where permissions are now calculated by spawning a new thread for each connection with the effective uid of the connecting user. The problem is&#8230;.</p>
<pre>
    root@server: ~ $ serveradmin settings afp:maxThreads
    afp:maxThreads = 40
  </pre>
<p>That seems kind of low given the above, right?  Apparently we should have at least one thread per client session, and this would include all your automounts&#8230;</p>
<p>I&#8217;ve set mine to 600 here like this:</p>
<pre>
    sudo serveradmin settings afp:maxThreads=600
  </pre>
<p>This is something that again will depend upon what else your AFP server is doing (ideally not much&#8230;) and how many clients and automounts you have.</p>
<p><b>Footnote: Working out the latency of a client connection and AFP client side debugging.</b></p>
<p>You may have noticed two debug settings in the AppleShareClientCore dictionary as you were applying those settings.</p>
<pre>
    afp_debug_level = 6
    afp_debug_syslog = 0
  </pre>
<p>If you set afp_debug_syslog to 1 (true), and add the following line to /etc/syslogd.conf,</p>
<pre>
  *.debug                                                 /var/log/debug.log
  </pre>
<p>then you&#8217;ll see a wealth of debugging info (depending upon the value from 1 to 8 you&#8217;ve set for afp_debug_level) go to /var/log/debug.log</p>
<p>This <b>isn&#8217;t</b> something you should just willy-nilly turn on for all your clients, as tempting as it may be to finally have debug info for AFP&#8230; Rather use it to have a look at what goes on when a client connects to an AFP mount.</p>
<p>You&#8217;ll notice if you have the debug level up quite high that you&#8217;ll see a bunch of times reported to the debug log.  I have yet to work out how to interpret those times to get the latency of a given client connection, and this is something  I&#8217;d like to know so that I can tune &#8216;real&#8217; values for my afp_wan_threshold. </p>
<p>So go forth! and work out how to do it. :)</p>
<p>As always, I&#8217;m not responsible for your server spontaneously combusting, your mileage may vary and this article may contain traces of nuts.</p>
<p>Many thanks must go to the <a href="http://www.afp548.com">afp548.com</a> posse, Joel n Josh for extensively talking through these issues with me, as well as bringing them to my attention&#8230; </p>
			</div><!-- .entry-content -->
	
	<footer class="entry-meta">
					<div class="comments-link">
				<a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/03/29/afp-it-aint-so-bad/#respond" title="Comment on AFP. It ain&#039;t so bad."><span class="leave-reply">Leave a comment</span></a>			</div><!-- .comments-link -->
		
			</footer><!-- .entry-meta -->
</article><!-- #post -->
							
<article id="post-96" class="post-96 post type-post status-publish format-standard hentry category-macosx category-software-and-scripts">
	<header class="entry-header">
		
				<h1 class="entry-title">
			<a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/02/09/forcing-mobile-home-directories-to-another-partition/" rel="bookmark">Forcing Mobile Home Directories to another partition.</a>
		</h1>
		
		<div class="entry-meta">
			<span class="date"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/02/09/forcing-mobile-home-directories-to-another-partition/" title="Permalink to Forcing Mobile Home Directories to another partition." rel="bookmark"><time class="entry-date" datetime="2006-02-09T01:19:53+00:00">February 9, 2006</time></a></span><span class="categories-links"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/macosx/" title="View all posts in macosx" rel="category tag">macosx</a>, <a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/software-and-scripts/" title="View all posts in software and scripts" rel="category tag">software and scripts</a></span><span class="author vcard"><a class="url fn n" href="http://explanatorygap.net/wp-content/plugins/really-static/static/author/nigelkersten/" title="View all posts by nigel kersten" rel="author">nigel kersten</a></span>					</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

		<div class="entry-content">
		<p>So we never keep our user&#8217;s local home directories at /Users, primarily so that we can always blow away the boot partition with our imaging system without worrying about user data.</p>
<p>We&#8217;ve started using Mobile Accounts for some of our desktop users due to some limitations in the OS X Server AFP server, and it was kind of bugging me that new Mobile Accounts would always get created at /Users/username, and we&#8217;d have to faff around with niutil in order to change this after the account had been created.</p>
<p>So I&#8217;ve managed to work out a LoginHook that will force Mobile Accounts to another location, even on the first login&#8230; I&#8217;m just showing part of it here, the bit that deals with such users, so some bits might strike you as the long way round&#8230;</p>
<pre>
#!/bin/bash
#

homes_disk="/Volumes/Storage"
local_homes="/Volumes/Storage/Users"

lookup_local=$(niutil -read . /users/$1 2> /dev/null)
if [ "$lookup_local" != "" ]; then
        is_local=1;
else
        is_local=0;
fi

# If they are a local user.
if [ $is_local -eq 1 ]; then
auth_prop=$(niutil -readprop . /users/$1 authentication_authority 2> /dev/null \
				   | grep LocalCachedUser)

# If they are a mobile user.
if [ "$auth_prop" != "" ]; then
  logger "LoginHook: Started for Mobile Account - $1"
  home_location=$(niutil -readprop . /users/$1 home)
  # If their home directory hasn't been moved to $local_homes yet.
  if [ "$home_location" != "$local_homes/$1" ]; then
      logger "LoginHook: Moving home from /Users/$1 to $local_homes/$1"
      if [ -e $homes_disk ]; then
        mkdir -p $local_homes
        chmod 1755 $local_homes
        chown root:admin $local_homes
        /System/Library/CoreServices/mcxd.app/Contents/Resources/MCXCacher \
        -U $1 -h $local_homes/$1
        ditto /Users/$1 $local_homes/$1
        rm -Rf /Users/$1
        sleep 2
        lookupd -flushcache
        sleep 2
      else
        logger "LoginHook: ERROR! Could not find $homes_disk"
      fi
  fi
    logger "LoginHook: Finished for Mobile Account - $1"
else
		logger "LoginHook: Not running for Local non-Mobile Account - $1"
fi

# If they are not local, they must be a network user.
else        
	logger "LoginHook: Started for Network Account - $1"
	# Do your stuff for network users here.
	logger "LoginHook: Finished for Network Account - $1"
fi
</pre>
			</div><!-- .entry-content -->
	
	<footer class="entry-meta">
					<div class="comments-link">
				<a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2006/02/09/forcing-mobile-home-directories-to-another-partition/#respond" title="Comment on Forcing Mobile Home Directories to another partition."><span class="leave-reply">Leave a comment</span></a>			</div><!-- .comments-link -->
		
			</footer><!-- .entry-meta -->
</article><!-- #post -->
							
<article id="post-97" class="post-97 post type-post status-publish format-standard hentry category-macosx">
	<header class="entry-header">
		
				<h1 class="entry-title">
			<a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2005/12/20/kadminlocal-unknown-credential-cache-type-while-opening-default-credentials-cache/" rel="bookmark">kadmin.local: Unknown credential cache type&#8230;</a>
		</h1>
		
		<div class="entry-meta">
			<span class="date"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2005/12/20/kadminlocal-unknown-credential-cache-type-while-opening-default-credentials-cache/" title="Permalink to kadmin.local: Unknown credential cache type&#8230;" rel="bookmark"><time class="entry-date" datetime="2005-12-20T20:48:05+00:00">December 20, 2005</time></a></span><span class="categories-links"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/macosx/" title="View all posts in macosx" rel="category tag">macosx</a></span><span class="author vcard"><a class="url fn n" href="http://explanatorygap.net/wp-content/plugins/really-static/static/author/nigelkersten/" title="View all posts by nigel kersten" rel="author">nigel kersten</a></span>					</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

		<div class="entry-content">
		<p>So I&#8217;ve been getting the above error when attempting to use kadmin.local on my OD Master for a while, through 10.3.x and 10.4.x OS X Server.</p>
<p>I had been doing something rather clunky to get around it, which was to destroy any existing Kerberos tickets before ssh&#8217;ing into the OD Master, which works fine, but is kind of annoying.</p>
<p>Turns out there is a much easier solution.<br />
<br />
Simply generate a ticket for a KDC admin account, and use that for the credentials cache.</p>
<pre>
localodadmin@odmaster: ~ $ kinit opendirectoryadmin
Please enter the password for opendirectoryadmin@MY.KERB.DOMAIN: 
localodadmin@odmaster: ~ $ sudo kadmin.local -c opendirectoryadmin
Authenticating as principal root/admin@MY.KERB.DOMAIN with existing credentials.
kadmin.local:  
</pre>
<p>
Much easier&#8230;</p>
			</div><!-- .entry-content -->
	
	<footer class="entry-meta">
					<div class="comments-link">
				<a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2005/12/20/kadminlocal-unknown-credential-cache-type-while-opening-default-credentials-cache/#respond" title="Comment on kadmin.local: Unknown credential cache type&#8230;"><span class="leave-reply">Leave a comment</span></a>			</div><!-- .comments-link -->
		
			</footer><!-- .entry-meta -->
</article><!-- #post -->
							
<article id="post-98" class="post-98 post type-post status-publish format-standard hentry category-macosxserver">
	<header class="entry-header">
		
				<h1 class="entry-title">
			<a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2005/12/20/migrating-open-directory-from-1039-to-104-problems-1/" rel="bookmark">Migrating Open Directory from 10.3.9 to 10.4 &#8211; Problems #1</a>
		</h1>
		
		<div class="entry-meta">
			<span class="date"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2005/12/20/migrating-open-directory-from-1039-to-104-problems-1/" title="Permalink to Migrating Open Directory from 10.3.9 to 10.4 &#8211; Problems #1" rel="bookmark"><time class="entry-date" datetime="2005-12-20T20:43:01+00:00">December 20, 2005</time></a></span><span class="categories-links"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/macosxserver/" title="View all posts in macosxserver" rel="category tag">macosxserver</a></span><span class="author vcard"><a class="url fn n" href="http://explanatorygap.net/wp-content/plugins/really-static/static/author/nigelkersten/" title="View all posts by nigel kersten" rel="author">nigel kersten</a></span>					</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

		<div class="entry-content">
		<p>Recently I finally bit the bullet and migrated my 10.3.9 Open Directory Master to 10.4.3, and ran into a couple of problems along the way&#8230;</p>
<p>Although I&#8217;ve been hearing the odd report about a successful upgrade, I decided I&#8217;d follow something similar to <a href="http://www.afp548.com/article.php?story=20050615173039158">Andrina&#8217;s article on afp548.com</a> on how to dump LDAP, Password Server and Kerberos, and then re-import those to a clean 10.4 Open Directory Master.</p>
<ol>
<li>The first problem I ran into was Andrina&#8217;s suggestion to use <code>mkpassdb -mergeparent</code>. Doing things this way will generate a new RSA key for the entire Password Server database, which is problematic for my setup. I have way too many mobile users (we&#8217;ve been using mobile accounts since they were introduced in 10.3) who have an <code>original_authentication_authority</code> property in their local mobile user record in NetInfo.  If the RSA key were to change, I&#8217;m pretty sure these accounts would essentially be orphaned, and I just decided I couldn&#8217;t take that risk, so I instead used <code>mkpassdb -mergedb</code>, which will replace the entire Password Server db from the 10.3.9 backup, rather than merging it with the clean 10.4.3 database.
</li>
<li>Another really really annoying problem I ran into regarded the use of slapcat and slapadd to dump and import the LDAP database.  I have quite a few &#8216;email only&#8217; user accounts that do not have a homedirectory property set.  As I&#8217;ve created these via Workgrop Manager, these are of the type &#8216;posixAccount&#8217;, and the LDAP schema definition for posixAccount requires that all such accounts MUST have a home property. slapadd refused to import these users.
<p>I had at least three options once I realised this was an issue. </p>
<ol>
<li>Reboot my existing 10.3.9 server, and use Workgroup Manager to export all the user records, then import them to the 10.4.3 server, and then use the ldap tools to overwrite the authentication_authority records for those accounts. As they had already been created, the ldap tools should have had no problem overwriting properties.
</li>
<li>Use ldapmodify/ldapadd to add the accounts from the ldif dump, as they ignore the schema checking that slapadd does. I&#8217;d run into some issues with the PWS import, so I was having trouble authenticating to the LDAP directory via password, and I also ran into some issues with the Kerberos import, mainly to do with not having an ldap principal for the OD master so I couldn&#8217;t authenticate that way either.
</li>
<li>Modify the schema for posixAccount such that it no longer required a home attribute.  This seemed to be the path of least resistance, so I went this way. To do this, edit /etc/openldap/schemas/nis.schema, and change the posixAccount definition:<br />
</p>
<pre>
objectclass ( 1.3.6.1.1.1.2.0 NAME 'posixAccount' SUP top AUXILIARY
        DESC 'Abstraction of an account with POSIX attributes'
       MUST ( cn $ uid $ uidNumber $ gidNumber $homeDirectory )
        MAY ( userPassword $ loginShell $ gecos $ description ) )
</pre>
<p>to:</p>
<pre>
objectclass ( 1.3.6.1.1.1.2.0 NAME 'posixAccount' SUP top AUXILIARY
        DESC 'Abstraction of an account with POSIX attributes'
       MUST ( cn $ uid $ uidNumber $ gidNumber )
        MAY ( userPassword $ loginShell $ gecos $ description ) )
</pre>
<p> Once I&#8217;d done this, slapadd happily added all my email-only users.
</li>
</ol>
</li>
<li>Kerberos. This caused me no end of pain.  I initially didn&#8217;t want to simply do mkpassdb -kerberize, as I wanted to keep all my existing host and service principals for all my other servers. This was me being kind of lazy, but I also wanted to keep the option to simply roll back to my 10.3.9 OD Master if the migration didn&#8217;t work out properly.
<p>In the end, after struggling with a bunch of different things, particularly the new kinds of principals in 10.4, I just realised I was being stubborn, and created an entirely new Kerberos setup. Part of the reason I was being so stubborn was due to me forgetting just how nice <code>mkpassdb -kerberize</code> is in 10.4. It&#8217;s a couple of minutes at most to generate an entirely new Kerberos setup from PWS/LDAP, and then it&#8217;s simply a matter of running <code>sso_util</code> on the other servers, and restarting any services that use Kerberos. Definitely the path of least resistance&#8230;
</li>
</ol>
			</div><!-- .entry-content -->
	
	<footer class="entry-meta">
					<div class="comments-link">
				<a href="http://explanatorygap.net/wp-content/plugins/really-static/static/2005/12/20/migrating-open-directory-from-1039-to-104-problems-1/#respond" title="Comment on Migrating Open Directory from 10.3.9 to 10.4 &#8211; Problems #1"><span class="leave-reply">Leave a comment</span></a>			</div><!-- .comments-link -->
		
			</footer><!-- .entry-meta -->
</article><!-- #post -->
			
				<nav class="navigation paging-navigation" role="navigation">
		<h1 class="screen-reader-text">Posts navigation</h1>
		<div class="nav-links">

						<div class="nav-previous"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/page/7/index.html" ><span class="meta-nav">&larr;</span> Older posts</a></div>
			
						<div class="nav-next"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/page/5/index.html" >Newer posts <span class="meta-nav">&rarr;</span></a></div>
			
		</div><!-- .nav-links -->
	</nav><!-- .navigation -->
	
		
		</div><!-- #content -->
	</div><!-- #primary -->


		</div><!-- #main -->
		<footer id="colophon" class="site-footer" role="contentinfo">
				<div id="secondary" class="sidebar-container" role="complementary">
		<div class="widget-area">
			<aside id="pages-2" class="widget widget_pages"><h3 class="widget-title">Pages</h3>		<ul>
			<li class="page_item page-item-2"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/about/">About/Contact</a></li>
<li class="page_item page-item-278"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/os-x-puppet-pkgs/">OS X Puppet pkgs</a></li>
		</ul>
		</aside><aside id="search-2" class="widget widget_search"><form role="search" method="get" class="search-form" action="http://explanatorygap.net/wp-content/plugins/really-static/static/">
				<label>
					<span class="screen-reader-text">Search for:</span>
					<input type="search" class="search-field" placeholder="Search &hellip;" value="" name="s" title="Search for:" />
				</label>
				<input type="submit" class="search-submit" value="Search" />
			</form></aside><aside id="tweetbox" class="widget tweetbox_widget"><h3 class="widget-title">Latest Tweets</h3><script type="text/javascript" src="http://explanatorygap.net/wp-content/plugins/tweetbox/tweetbox.js"></script><script>getTweets('nigelkersten', 3, '')</script><div id="tweetboxtweets">Fetching latest tweets...</div></aside><aside id="categories-1" class="widget widget_categories"><h3 class="widget-title">Categories</h3>		<ul>
	<li class="cat-item cat-item-5"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/nix/" title="View all posts filed under *nix">*nix</a>
</li>
	<li class="cat-item cat-item-6"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/macosx/" title="View all posts filed under macosx">macosx</a>
</li>
	<li class="cat-item cat-item-3"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/macosxserver/" title="View all posts filed under macosxserver">macosxserver</a>
</li>
	<li class="cat-item cat-item-13"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/puppet/" title="View all posts filed under puppet">puppet</a>
</li>
	<li class="cat-item cat-item-15"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/python/" title="View all posts filed under python">python</a>
</li>
	<li class="cat-item cat-item-4"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/ramblings/" title="View all posts filed under ramblings">ramblings</a>
</li>
	<li class="cat-item cat-item-2"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/snippets/" title="Snippets">Snippets</a>
</li>
	<li class="cat-item cat-item-7"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/software-and-scripts/" title="View all posts filed under software and scripts">software and scripts</a>
</li>
	<li class="cat-item cat-item-1"><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/category/uncategorized/" title="View all posts filed under Uncategorized">Uncategorized</a>
</li>
		</ul>
</aside><aside id="meta-2" class="widget widget_meta"><h3 class="widget-title">Meta</h3>			<ul>
						<li><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/wp-login.php">Log in</a></li>
			<li><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/feed/" title="Syndicate this site using RSS 2.0">Entries <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="http://explanatorygap.net/wp-content/plugins/really-static/static/comments/feed/" title="The latest comments to all posts in RSS">Comments <abbr title="Really Simple Syndication">RSS</abbr></a></li>
<li><a href="https://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress.org</a></li>			</ul>
</aside><aside id="linkcat-10" class="widget widget_links"><h3 class="widget-title">Mac Dev Blogs</h3>
	<ul class='xoxo blogroll'>
<li><a href="http://ridiculousfish.com/blog/">Ridiculous Fish</a></li>
<li><a href="http://www.theocacao.com/" title="Scott Stevenson&#8217;s blog">theocacao.com</a></li>

	</ul>
</aside>
<aside id="linkcat-8" class="widget widget_links"><h3 class="widget-title">Mac Tech Blogs</h3>
	<ul class='xoxo blogroll'>
<li><a href="http://bynkii.com/" title="John C. Welch&#8217;s blog&#8230; the reason God invented the middle finger&#8230;">bynkii.com</a></li>
<li><a href="http://arstechnica.com/staff/fatbits.ars" title="John Siracusa&#8217;s Journal">fatbits</a></li>
<li><a href="http://iamleeg.blogspot.com/" title="Graham Lee&#8217;s blog&#8230; lots of Darwin and Openstep.">i am leeg</a></li>
<li><a href="http://managingosx.wordpress.com/" title="Greg Neagle&#8217;s Managing OS X blog">managing os x</a></li>
<li><a href="http://northstarlabs.net" title="Jeff McCune&#8217;s sysadmin blog">northstarlabs.net</a></li>
<li><a href="http://www.radiotope.com/writing/" title="Edward Marczak&#8217;s blog&#8230; the oneness of tech..">tech zendo</a></li>
<li><a href="http://www.dreness.com/blog/" title="Andre&#8217;s Mac geek blog&#8230;">the bits</a></li>
<li><a href="http://yourmacguy.wordpress.com/" title="Peter Bukowinski&#8217;s blog">Your Mac Guy</a></li>

	</ul>
</aside>
<aside id="linkcat-9" class="widget widget_links"><h3 class="widget-title">Mac Technical Sites</h3>
	<ul class='xoxo blogroll'>
<li><a href="http://www.afp548.com" title="We put the M in RTFM&#8230;">AFP548.com</a></li>
<li><a href="http://www.macenterprise.org" title="The MacEnterprise project is a community of IT professionals sharing information and solutions to support Macs in an enterprise.">MacEnterprise.org</a></li>
<li><a href="http://xsanity.com/">xsanity</a></li>

	</ul>
</aside>
<aside id="linkcat-12" class="widget widget_links"><h3 class="widget-title">Social</h3>
	<ul class='xoxo blogroll'>
<li><a href="http://yumamino.com/" title="Tane Potaka&#8217;s blog">Yumamino</a></li>

	</ul>
</aside>
		</div><!-- .widget-area -->
	</div><!-- #secondary -->

			<div class="site-info">
								<a href="http://wordpress.org/" title="Semantic Personal Publishing Platform">Proudly powered by WordPress</a>
			</div><!-- .site-info -->
		</footer><!-- #colophon -->
	</div><!-- #page -->

	<script type='text/javascript' src='http://explanatorygap.net/wp-includes/js/masonry.min.js?ver=3.1.2'></script>
<script type='text/javascript' src='http://explanatorygap.net/wp-includes/js/jquery/jquery.masonry.min.js?ver=3.1.2'></script>
<script type='text/javascript' src='http://explanatorygap.net/wp-content/themes/twentythirteen/js/functions.js?ver=2013-07-18'></script>
</body>
</html>
<!-- Dynamic Page Served (once) in 0.350 seconds -->
